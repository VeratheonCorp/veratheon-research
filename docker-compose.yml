version: '3.8'

services:
  # PostgreSQL database for Prefect
  postgres:
    image: postgres:16
    container_name: market-research-postgres
    environment:
      POSTGRES_DB: prefect
      POSTGRES_USER: prefect
      POSTGRES_PASSWORD: prefect123
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U prefect -d prefect"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis for caching and pub/sub
  redis:
    image: redis:7-alpine
    container_name: market-research-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Prefect server
  prefect-server:
    image: prefecthq/prefect:3-python3.12
    container_name: market-research-prefect-server
    command: prefect server start --host 0.0.0.0
    environment:
      PREFECT_SERVER_DATABASE_CONNECTION_URL: postgresql+asyncpg://prefect:prefect123@postgres:5432/prefect
      PREFECT_API_URL: http://0.0.0.0:4200/api
      # Use relative API URL so UI automatically uses the same host it was accessed from
      PREFECT_UI_API_URL: /api
    ports:
      - "4200:4200"
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:4200/api/health')"]
      interval: 30s
      timeout: 10s
      retries: 5

  # Main market research application - API Server
  market-research-api:
    build: .
    container_name: market-research-api
    environment:
      PREFECT_API_URL: http://prefect-server:4200/api
      REDIS_URL: redis://redis:6379
      # Add your API keys here or use .env file
      # ALPHA_VANTAGE_API_KEY: ${ALPHA_VANTAGE_API_KEY}
      # OPENAI_API_KEY: ${OPENAI_API_KEY}
      # MODEL_SELECTED: ${MODEL_SELECTED}
    volumes:
      # Volume map source code for development
      - ./src:/app/src:rw
      - ./tests:/app/tests:rw
      - ./run.py:/app/run.py:rw
      - ./run_api.py:/app/run_api.py:rw
      - ./.env:/app/.env:ro
    ports:
      - "8000:8000"  # For API server
    depends_on:
      prefect-server:
        condition: service_healthy
      redis:
        condition: service_healthy
    command: >
      sh -c "
        echo 'Waiting for Prefect server to be ready...' &&
        sleep 10 &&
        echo 'Registering Prefect deployments...' &&
        PYTHONPATH=/app uv run python src/prefect/deployments.py &&
        echo 'Starting API server...' &&
        PYTHONPATH=/app uv run python run_api.py
      "

  # Prefect Worker - runs the actual flows
  prefect-worker:
    build: .
    container_name: market-research-worker
    environment:
      PREFECT_API_URL: http://prefect-server:4200/api
      REDIS_URL: redis://redis:6379
      # Add your API keys here or use .env file
      # ALPHA_VANTAGE_API_KEY: ${ALPHA_VANTAGE_API_KEY}
      # OPENAI_API_KEY: ${OPENAI_API_KEY}
      # MODEL_SELECTED: ${MODEL_SELECTED}
    volumes:
      # Volume map source code for development
      - ./src:/app/src:rw
      - ./tests:/app/tests:rw
      - ./run.py:/app/run.py:rw
      - ./run_api.py:/app/run_api.py:rw
      - ./.env:/app/.env:ro
    depends_on:
      prefect-server:
        condition: service_healthy
      redis:
        condition: service_healthy
    command: >
      sh -c "
        echo 'Waiting for Prefect server and deployments...' &&
        sleep 15 &&
        echo 'Starting Prefect worker...' &&
        PYTHONPATH=/app uv run prefect worker start --pool default-agent-pool
      "

volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local